# TLB (Transition Look-aside Buffer)

---

![Untitled](TLB(Transition_Look-aside_Buffer)/Untitled.png)

# 정의

- TLB(Translation Lookaside Buffer)는 가상 주소를 물리적 주소로 변환하는 속도를 높이는 캐시 메모리 역할을 하는 최신 운영 체제의 필수 구성 요소이다.
- 최근에 사용한 트랜잭션을 추적하는 데 사용되는 특수 캐시다.
    - 더 빠른 검색을 위해 가상 메모리의 최근 변환을 실제 주소로 저장하는 메모리 캐시의 유형.
    - TLB에는 VPN(Virtual Page Number)와 PFN(Physical Frame Number) 정보가 쌍으로 존재하며 이를 사용해 주소 변환을 하도록 도와준다.
    - 그 외에도 실제 페이지가 주 메모리에 있는 위치에 대한 정보, 유효/유효하지 않은 비트, 수정 여부에 대한 더티 비트, page table에서 같은 page에 접근할 수 있는지 확인하는 보호 비트 등의 비트 정보가 포함되어 있다.
- 가장 최근에 사용된 페이지 테이블 항목(PTE)이 포함되어 있으며, 가상 주소가 주어지면 프로세서는 페이지 테이블 항목이 존재하는지 (TLB Hit) TLB를 검사하고 프레임 번호를 검색하여 실제 주소가 형성된다.
    - 이 시점에서 TLB가 물리적 메모리의 위치에 대한 빠른 참조를 확인한다. 과정은 다음과 같다.
        - CPU가 가상 주소(논리 주소)를 생성한다.
        - 주소는 TLB에서 확인된다.
        - 주소가 있으면 해당 프레임 번호가 검색된다
        - CPU는 페이지가 주 메모리의 어디에 있는지 확인 가능하다.
    - TLB Hit은 기본적으로 Temporal Locality 개념을 사용하여 TLB Hit Rate를 높인다.
        
        → 데이터 검색이 빨라진다.
        
- TLB에 페이지 테이블 엔트리가 없으면 (TLB Miss) 페이지 테이블을 처리하는 동안 해당 페이지 번호를 인덱스로 사용한다.
    - 메모리 페이지 크롤링 작업을 통해 물리적 메모리를 검색하며, 가상 메모리 주소가 변환되면 참조된 값이 TLB에 추가된다.
    - 대부분의 프로세서에는 고유한 대기 시간을 통해 가상 메모리 작업 속도를 높이기 위해 TLB가 포함되어 있다. 과정은 다음과 같다.
        - CPU는 가상 주소를 생성한다
        - 주소는 TLB에서는 확인되지만 실제로 존재하진 않는다.
        - 페이지 번호는 주 메모리에 있는 페이지 테이블과 일치한다
        - 해당 프레임 번호가 검색된다
        - CPU는 페이지가 주 메모리의 어디에 있는지 확인 가능하다
        - TLB가 새로운 PTE로 업데이트 된다.
- TLB는 먼저 페이지가 이미 주 메모리에 있는지 확인하고, 주 메모리에 없으면 페이지 오류가 발생한 다음 TLB가 새 페이지 항목을 포함하도록 업데이트한다.
- TLB를 사용하면 레지스터에 PTE를 배치할 필요가 없다. 또는 두 개의 주 메모리 참조가 필요한 주 메모리에 전체 페이지 테이블을 유지할 필요가 없다.
- TLB는 참조 지역성 개념을 기반으로 한다. 즉, 중앙 처리 장치가 자주 액세스해야 하는 페이지의 항목만 포함한다.
- TLB는 레지스터보다 저렴하고 크기가 크며, 주 메모리보다 빠르고 작은 메모리 유형이다.
- 메모리 주소가 TLB에 저장되어 있고 거기에서 검색할 수 있다면(TLB HIT) 속도가 향상된다.
- 단, TLB는 멀티태스킹 및 코드 오류로 인해 성능 문제가 발생할 수 있다.
- 캐시 스레시(cache thrash)라고 하는 성능 저하는 리소스의 과도한 사용이나 캐싱 시스템의 충돌로 인해 진행되지 않는 지속적인 컴퓨터 활동으로 인해 발생한다.

# 이슈

### Context Switches

- TLB 사용 시 Context Switch가 발생할 경우, 여러 프로세스가 각자 자신의 가상 메모리 공간이 존재하며 각자의 가상 메모리 공간이 Page로 쪼개지며 많은 프로세스가 존재할 경우, Page Table의 Index가 같은 경우가 발생할 수 있다.
    - 이 경우 어떤 정보가 어떤 프로세스의 정보인지 확인할 수 없으며, 프로세스에서 서로의 주소 공간이 아닌 곳에 접근할 수 있게 된다.
- 위 문제를 해결하기 위한 방법 중 하나는 Flush로, Context Switch가 발생할 때 기존 프로세스의 주소변환 정보를 TLB에서 모두 지워버리는 방법이 있다.
    - Flush는 TLB의 주소 변환 정보 중 Valid 비트의 값을 0으로 초기화함으로서 수행한다.
    - 단, Context Switch마다 추가 작업으로 인한 비용이 발생하며, Page Table을 매번 다시 접근해야 하는 문제가 발생한다.
        - 위의 오버헤드를 줄이기 위한 방법으로는 TLB 구조에 ASID(Address Space Indentifier)를 추가하는 방법이 있다. 프로세스마다 다른 ASID 정보를 통해 각 프로세스를 식별함으로서 HW 레벨에서 문제를 해결하는 것이다.

### Replacement Policy

- TLB에 저장 공간이 가득 찬 경우에 새로운 프로세스가 실행 될 때, TLB의 어떤 데이터를 지워야 하는지에 대한 이슈다.
    - 일반적인 방법으로는 LRU(Least Recently Used Algorithm) 혹은 Random 제거 방식이 있다.

# TLB 히트와 미스

## TLB 히트

![Untitled](TLB(Transition_Look-aside_Buffer)/Untitled1.png)

- TLB에 메모리 액세스 작업에 필요한 가상,물리적 주소 변환이 포함되어 있으면 TLB 적중이 발생한다.
    - 쉽게 말해, TLB에 원하는 가상 주소와 해당하는 물리 주소의 매핑 정보가 이미 저장되어 있을 때를 말한다.
- TLB 적중이 발생하면 관련 단계는 비교적 간단하고 효율적이다.

1. CPU는 일반적으로 로드 또는 저장 명령의 일부로 가상 메모리 주소를 생성한다.
2. CPU는 생성된 가상 주소와 TLB에 저장된 항목이 일치하는지 확인한다.
3. CPU는 TLB 항목에서 해당 물리적 주소를 검색한다. 이 물리적 주소는 메인 메모리(RAM)에 저장된 실제 데이터에 액세스하는 데 사용된다.
4. TLB에서 얻은 물리적 주소를 사용하여 CPU는 주 메모리의 데이터에 액세스할 수 있다.

## TLB 미스

![Untitled](TLB(Transition_Look-aside_Buffer)/Untitled2.png)

- TLB 누락이 발생하면 TLB에 메모리 액세스 작업에 필요한 가상-물리 주소 변환이 포함되어 있지 않음을 의미한다.
- 이 경우 OS와 하드웨어는 필요한 번역을 검색하기 위해 추가 단계를 수행하여야 한다.

1. 프로그램이나 프로세스는 가상 메모리 주소를 생성하여 메모리 액세스 작업을 시작한다.
2. CPU는 생성된 가상 주소와 TLB에 저장된 항목이 일치하는지 TLB를 확인한다. TLB 누락의 경우 TLB에서 일치하는 항목을 찾을 수 없다.
3. 이제 CPU는 운영 체제가 유지 및 관리하는 주 메모리의 데이터 구조인 페이지 테이블을 참조해야 한다.
4. CPU는 가상 주소에 해당하는 페이지 테이블 항목을 검색하기 위해 페이지 테이블에 액세스한다.
5. CPU는 새로운 번역 정보로 TLB를 업데이트한다.
6. 페이지 테이블 항목의 변환 정보를 사용하여 CPU는 원래 가상 주소에 해당하는 물리적 주소를 계산한다.
7. 이제 CPU는 계산된 물리적 주소를 사용하여 주 메모리에 저장된 데이터에 액세스할 수 있다.

# 장단점

## 장점

TLB(Translation Lookaside Buffer)는 컴퓨터 시스템, 특히 메모리 관리 및 가상 메모리 측면에서 여러 가지 이점을 제공한다. 

1. **더 빠른 메모리 액세스** 
    
    TLB는 가상-물리적 주소 변환 프로세스를 가속화한다.
    
2. **지연 시간 단축** 
    
    자주 사용되는 주소 변환을 캐싱함으로써 TLB는 자주 액세스하는 데이터를 보다 신속하게 검색할 수 있도록 보장하여 시스템 응답성을 향상시킨다.
    
3. **가상 메모리의 효율적인 사용** 
    
    TLB는 자주 사용되는 주소 변환을 캐시하여 모든 메모리 참조에 대해 주 메모리의 페이지 테이블에 액세스할 필요성을 줄여 가상 메모리를 효율적으로 관리하는 데 도움이 된다.
    
4. **낮은 전력 소비** 
    
    TLB는 메모리 액세스 빈도를 줄임으로써 전력 소비를 낮추는 데 기여할 수 있으며 이는 모바일 장치 및 에너지 효율적인 컴퓨팅 환경에서 특히 중요하다.
    
5. **최소화된 페이지 테이블 액세스** 
    
    TLB가 없으면 모든 가상 주소를 실제 주소로 변환하려면 주 메모리의 페이지 테이블에 액세스해야 하므로 시간이 많이 걸릴 수 있다.
    
6. **향상된 시스템 응답성** 
    
    TLB는 프로그램 실행의 기본인 메모리 액세스 작업이 가능한 한 빠르도록 보장하여 인지된 지연을 줄이고 보다 원활한 사용자 경험을 보장한다.
    

## 단점

TLB(Translation Lookaside Buffer)는 메모리 액세스 속도와 효율성을 향상시키는 데 상당한 이점을 제공하지만 다음과 같은 몇 가지 제한 사항과 과제도 있다.

1. **제한된 크기** 
    
    TLB에는 유한한 수의 항목이 있으며 크기는 하드웨어 제약 조건에 의해 제한된다.
    
2. **관리 오버헤드** 
    
    항목 업데이트 및 제거를 포함하여 TLB를 관리하면 메모리 액세스 작업에 약간의 오버헤드가 추가된다.
    
3. **복잡한 하드웨어** 
    
    TLB에는 추가 하드웨어 구성 요소가 필요하므로 CPU 또는 메모리 관리 장치의 비용과 복잡성이 증가할 수 있다.
    
4. **캐시 일관성** 
    
    다중 프로세서 시스템이나 다중 캐시가 있는 시스템에서는 TLB를 포함하여 캐시 일관성을 유지하는 것이 어려울 수 있다.
    
5. **TLB 미스 페널티** 
    
    TLB 누락이 발생하고 필요한 변환이 TLB에 없으면 메모리 액세스 시간이 길어진다.
    
6. **비효율적인 공간 활용** 
    
    TLB가 항상 완전히 활용되는 것은 아니며 매핑이 자주 변경되면 일부 항목이 오래될 수 있다.
    

# 결론

- TLB(Translation Lookaside Buffer)는 자주 사용되는 가상-물리 메모리 주소 변환을 저장하도록 설계된 하드웨어 캐시로, 컴퓨터 시스템에서 중요한 구성 요소 역할을 한다.
- TLB는 자주 액세스되는 주소 변환에 대한 신속한 액세스를 제공하여 메모리 액세스 대기 시간을 크게 줄이고 전체 시스템 성능을 향상시키기 때문에 최신 CPU에 필수적이다.
- TLB 누락이 발생하면(즉, 필요한 변환이 TLB에서 발견되지 않음을 의미) CPU는 필요한 주소 변환을 가져오기 위해 메인 메모리의 페이지 테이블에 액세스해야 하므로 추가 대기 시간이 발생한다.
- TLB 크기, 교체 정책, 자주 액세스되는 주소 변환의 우선순위 지정과 같은 요소의 신중한 최적화를 통해 TLB 효율성을 향상할 수 있으며, 이 모두는 TLB 누락을 최소화한다.

# 참고

## EAT란?

- 운영 체제의 TLB(Translation Lookaside Buffer)와 관련하여 "유효 액세스 시간"(EAT)은 TLB 적중 및 TLB 누락 가능성을 모두 고려하여 메모리 액세스 작업을 완료하는 데 걸리는 총 시간을 나타낸다. TLB가 탑재된 메모리 시스템의 전반적인 성능을 평가하는 데 사용되는 중요한 지표이다.
- EAT(유효 액세스 시간)는 다음 공식을 사용하여 계산할 수 있다.
    - 먹다=( 적중 시간*적중률 )+( 미스 페널티*미스레이트 )
    - **적중 시간**
        
        TLB 조회를 수행하고 TLB 적중이 있는 경우 물리적 주소를 검색하는 데 걸리는 시간이다. 즉, 성공적인 TLB 액세스에 걸리는 시간을 나타낸다.
        
    - **적중률**
        
        이는 메모리 액세스로 인해 TLB 적중이 발생할 확률이다. 이는 TLB 히트 수를 총 메모리 액세스 수로 나누어 계산된다.
        
    - **미스 페널티**
        
        TLB Miss를 해결하는데 걸리는 시간이다. 여기에는 주 메모리의 페이지 테이블에 액세스하고 잠재적으로 누락된 번역으로 TLB를 업데이트하는 데 필요한 시간이 포함된다.
        
    - **미스율**
        
        이는 메모리 액세스로 인해 TLB 미스가 발생할 확률이다. 이는 TLB 누락 수를 총 메모리 액세스 수로 나누어 계산된다.